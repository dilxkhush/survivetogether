<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HopeConnect Platform</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        
        /* Custom spinner */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border-left-color: #fff;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Simple fade-in animation for view transitions */
        .animate-fadeIn {
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Custom pulse animation for hero buttons */
        .animate-pulse-bright {
            animation: pulse-bright 2s infinite;
        }
        @keyframes pulse-bright {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4);
            }
            70% {
                transform: scale(1.02);
                box-shadow: 0 0 0 10px rgba(99, 102, 241, 0);
            }
        }
    </style>
</head>
<body class="bg-gray-100 h-full">
    
    <div id="app-wrapper" class="flex flex-col min-h-screen">
        
        <!-- Header -->
        <nav class="bg-white shadow-md w-full fixed top-0 left-0 z-50">
            <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <!-- Logo / Title -->
                    <div class="flex-shrink-0 flex items-center">
                        <span class="text-2xl font-bold text-indigo-600">HopeConnect</span>
                    </div>
                    <!-- Admin Link -->
                    <div>
                        <button class="nav-button text-sm font-medium text-gray-600 hover:text-indigo-600" data-target="admin-view">
                            Admin Panel
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content Area -->
        <main id="view-container" class="flex-grow pt-16">
            
            <!-- View 1: Home View (The main choice) -->
            <div id="home-view" class="max-w-6xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
                <section class="text-center">
                    <h1 class="text-4xl font-extrabold text-gray-900 sm:text-5xl md:text-6xl">
                        Welcome to <span class="text-indigo-600">HopeConnect</span>
                    </h1>
                    <p class="mt-3 max-w-md mx-auto text-base text-gray-500 sm:text-lg md:mt-5 md:text-xl md:max-w-3xl">
                        Connecting those who need help with those who can give it.
                    </p>
                    <p class="mt-2 max-w-md mx-auto text-base text-gray-500 sm:text-lg md:text-xl md:max-w-3xl">
                        How can we help you today?
                    </p>
                </section>
                
                <div class="mt-12 grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Card 1: I Need Help -->
                    <button class="nav-button card-button animate-pulse-bright group" data-target="get-help-view">
                        <div class="bg-white rounded-xl shadow-lg overflow-hidden h-full flex flex-col justify-between p-8 text-left transition-all duration-300 transform group-hover:shadow-2xl group-hover:-translate-y-1">
                            <div>
                                <div class="inline-flex items-center justify-center h-12 w-12 rounded-md bg-indigo-100 text-indigo-600">
                                    <!-- Simple "receiving hand" icon -->
                                    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 11.25v8.25a1.5 1.5 0 01-1.5 1.5H5.25a1.5 1.5 0 01-1.5-1.5v-8.25M12 4.875A2.625 2.625 0 1012 10.125A2.625 2.625 0 0012 4.875z" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 10.125c-2.31 0-4.418.91-5.996 2.408L1.758 15.75M12 10.125c2.31 0 4.418.91 5.996 2.408L22.242 15.75" /></svg>
                                </div>
                                <h3 class="mt-4 text-2xl font-bold text-gray-900">I Need Help</h3>
                                <p class="mt-2 text-gray-600">
                                    If you are a survivor or in need of assistance, please fill out our secure form. We are here to support you.
                                </p>
                            </div>
                            <span class="mt-6 font-semibold text-indigo-600 group-hover:text-indigo-500">
                                Apply for Assistance &rarr;
                            </span>
                        </div>
                    </button>
                    
                    <!-- Card 2: I Want to Help -->
                    <button class="nav-button card-button group" data-target="give-help-view">
                        <div class="bg-white rounded-xl shadow-lg overflow-hidden h-full flex flex-col justify-between p-8 text-left transition-all duration-300 transform group-hover:shadow-2xl group-hover:-translate-y-1">
                            <div>
                                <div class="inline-flex items-center justify-center h-12 w-12 rounded-md bg-emerald-100 text-emerald-600">
                                    <!-- Simple "heart" icon -->
                                    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z" /></svg>
                                </div>
                                <h3 class="mt-4 text-2xl font-bold text-gray-900">I Want to Help</h3>
                                <p class="mt-2 text-gray-600">
                                    Join our mission as a volunteer or make a donation. Your support can change lives.
                                </p>
                            </div>
                            <span class="mt-6 font-semibold text-emerald-600 group-hover:text-emerald-500">
                                Donate or Volunteer &rarr;
                            </span>
                        </div>
                    </button>
                </div>
            </div>

            <!-- View 2: Get Help Form -->
            <div id="get-help-view" class="hidden max-w-2xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
                <button class="nav-button mb-4 text-sm font-medium text-indigo-600 hover:text-indigo-500" data-target="home-view">
                    &larr; Back to Home
                </button>
                <div class="bg-white p-8 rounded-xl shadow-lg">
                    <h2 class="text-3xl font-bold text-gray-900">Request for Assistance</h2>
                    <p class="mt-2 text-sm text-gray-600">Please fill out this form with honest details. Your information is confidential.</p>
                    
                    <form id="help-form" class="mt-8 space-y-6">
                        <!-- Personal Info -->
                        <div>
                            <label for="full-name" class="block text-sm font-medium text-gray-700">Full Name</label>
                            <input id="full-name" name="full-name" type="text" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm h-10 px-3">
                        </div>
                        <div>
                            <label for="phone-number" class="block text-sm font-medium text-gray-700">Phone Number</label>
                            <input id="phone-number" name="phone-number" type="tel" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm h-10 px-3">
                        </div>
                        <div>
                            <label for="address" class="block text-sm font-medium text-gray-700">Full Address (City, State)</label>
                            <textarea id="address" name="address" rows="3" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-3"></textarea>
                        </div>
                        
                        <!-- Household -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="adults" class="block text-sm font-medium text-gray-700">Adults in household</label>
                                <input type="number" name="adults" id="adults" min="0" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm h-10 px-3">
                            </div>
                            <div>
                                <label for="children" class="block text-sm font-medium text-gray-700">Children in household</label>
                                <input type="number" name="children" id="children" min="0" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm h-10 px-3">
                            </div>
                        </div>

                        <!-- Situation -->
                        <div>
                            <label for="situation-details" class="block text-sm font-medium text-gray-700">Please describe your situation</label>
                            <textarea id="situation-details" name="situation-details" rows="5" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-3" placeholder="What happened, and what kind of help do you need?"></textarea>
                        </div>

                        <!-- Verification -->
                        <div>
                            <h3 class="text-sm font-medium text-gray-700">Reference (Optional)</h3>
                            <p class="text-xs text-gray-500">A community leader, social worker, or neighbor who can verify your situation.</p>
                            <div class="grid grid-cols-2 gap-4 mt-2">
                                <div>
                                    <label for="reference-name" class="sr-only">Reference Name</label>
                                    <input type="text" name="reference-name" id="reference-name" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm h-10 px-3" placeholder="Reference's Name">
                                </div>
                                <div>
                                    <label for="reference-phone" class="sr-only">Reference Phone</label>
                                    <input type="tel" name="reference-phone" id="reference-phone" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm h-10 px-3" placeholder="Reference's Phone">
                                </div>
                            </div>
                        </div>

                        <!-- Declaration -->
                        <div class="flex items-center">
                            <input id="declaration" name="declaration" type="checkbox" required class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                            <label for="declaration" class="ml-2 block text-sm text-gray-900">I declare that the information provided is true.</label>
                        </div>
                        
                        <!-- Message Box -->
                        <div id="message-box" class="hidden rounded-md p-4">
                            <p id="message-text"></p>
                        </div>

                        <!-- Submit Button -->
                        <div>
                            <button type="submit" id="submit-button" class="group relative flex w-full justify-center rounded-md border border-transparent bg-indigo-600 py-3 px-4 text-sm font-semibold text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-all">
                                <span id="submit-text">Submit Request</span>
                                <span id="submit-spinner" class="hidden spinner"></span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- View 3: Give Help (Donate / Volunteer) -->
            <div id="give-help-view" class="hidden max-w-2xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
                <button class="nav-button mb-4 text-sm font-medium text-indigo-600 hover:text-indigo-500" data-target="home-view">
                    &larr; Back to Home
                </button>
                <div class="bg-white p-8 rounded-xl shadow-lg space-y-8">
                    <!-- Donation Section -->
                    <section>
                        <h2 class="text-3xl font-bold text-gray-900">Make a Donation</h2>
                        <p class="mt-2 text-sm text-gray-600">Your contribution (demo) directly supports those in need. (No real payment will be processed).</p>
                        
                        <form id="donation-form" class="mt-6">
                            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                                <button type="button" class="donation-amount p-4 rounded-md border-2 border-gray-300 text-center font-bold text-gray-700 hover:border-indigo-500 hover:bg-indigo-50 focus:border-indigo-600 focus:bg-indigo-50 focus:outline-none">$10</button>
                                <button type="button" class="donation-amount p-4 rounded-md border-2 border-gray-300 text-center font-bold text-gray-700 hover:border-indigo-500 hover:bg-indigo-50 focus:border-indigo-600 focus:bg-indigo-50 focus:outline-none">$25</button>
                                <button type="button" class="donation-amount p-4 rounded-md border-2 border-gray-300 text-center font-bold text-gray-700 hover:border-indigo-500 hover:bg-indigo-50 focus:border-indigo-600 focus:bg-indigo-50 focus:outline-none">$50</button>
                                <button type="button" class="donation-amount p-4 rounded-md border-2 border-gray-300 text-center font-bold text-gray-700 hover:border-indigo-500 hover:bg-indigo-50 focus:border-indigo-600 focus:bg-indigo-50 focus:outline-none">$100</button>
                            </div>
                            <div class="mt-4">
                                <label for="custom-amount" class="sr-only">Custom Amount</label>
                                <div class="relative rounded-md shadow-sm">
                                    <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                                        <span class="text-gray-500 sm:text-sm">$</span>
                                    </div>
                                    <input type="number" name="custom-amount" id="custom-amount" class="block w-full rounded-md border-gray-300 pl-7 pr-12 focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm h-12" placeholder="0.00">
                                </div>
                            </div>
                            <!-- Message Box -->
                            <div id="donation-message-box" class="hidden rounded-md p-4 mt-4">
                                <p id="donation-message-text"></p>
                            </div>
                            <button type="submit" id="donate-button" class="mt-6 w-full flex justify-center rounded-md border border-transparent bg-emerald-600 py-3 px-4 text-sm font-semibold text-white hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 transition-all">
                                Donate Now
                            </button>
                        </form>
                    </section>
                    
                    <!-- Divider -->
                    <div class="border-t border-gray-200"></div>
                    
                    <!-- Volunteer Section -->
                    <section>
                        <h2 class="text-3xl font-bold text-gray-900">Become a Volunteer</h2>
                        <p class="mt-2 text-sm text-gray-600">
                            We are always looking for passionate individuals to help with logistics, outreach, and support. 
                            If you're interested in volunteering your time, please email our coordinator at 
                            <a href="mailto:volunteer@hopeconnect.org" class="font-medium text-indigo-600 hover:underline">volunteer@hopeconnect.org</a>.
                        </p>
                    </section>
                </div>
            </div>
            
            <!-- View 4: Admin Panel -->
            <div id="admin-view" class="hidden max-w-4xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
                <button class="nav-button mb-4 text-sm font-medium text-indigo-600 hover:text-indigo-500" data-target="home-view">
                    &larr; Back to Home
                </button>
                <h2 class="text-3xl font-bold text-gray-900">Admin Panel: Help Requests</h2>
                <p class="mt-2 text-sm text-gray-600">New requests from survivors will appear here in real-time.</p>
                
                <!-- User ID Display -->
                <div class="my-4 p-3 bg-white rounded-lg shadow-sm text-center">
                    <span class="text-sm font-medium text-gray-700">Your Admin User ID (for debugging): </span>
                    <code id="admin-user-id" class="text-sm text-indigo-700 bg-indigo-50 p-1 rounded">Loading...</code>
                </div>

                <div id="requests-list" class="mt-6 space-y-4">
                    <!-- Loading state -->
                    <div id="admin-loading" class="text-center text-gray-500 py-10">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m-15.357-2A8.001 8.001 0 0019.418 15m0 0H15" /></svg>
                        <p class="mt-2 text-sm font-medium">Loading requests...</p>
                    </div>
                    <!-- Empty state -->
                    <div id="admin-empty" class="hidden text-center text-gray-500 bg-white p-10 rounded-lg shadow-sm">
                        <svg class="mx-auto h-12 w-12 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" /></svg>
                        <p class="mt-2 text-sm font-medium">No help requests have been submitted yet.</p>
                    </div>
                    <!-- Requests will be injected here -->
                </div>
            </div>
            
        </main>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            onSnapshot, 
            query,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfigStr = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let db, auth, userId;
        let unsubscribeFromRequests = null; 

        // --- UI Elements ---
        const viewContainer = document.getElementById('view-container');
        const allViews = viewContainer.querySelectorAll('div[id$="-view"]');
        const navButtons = document.querySelectorAll('.nav-button');
        
        // "Get Help" Form
        const helpForm = document.getElementById('help-form');
        const submitButton = document.getElementById('submit-button');
        const submitText = document.getElementById('submit-text');
        const submitSpinner = document.getElementById('submit-spinner');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        
        // "Give Help" Form
        const donationForm = document.getElementById('donation-form');
        const donationMessageBox = document.getElementById('donation-message-box');
        const donationMessageText = document.getElementById('donation-message-text');

        // Admin Panel
        const requestsList = document.getElementById('requests-list');
        const adminLoading = document.getElementById('admin-loading');
        const adminEmpty = document.getElementById('admin-empty');
        const adminUserId = document.getElementById('admin-user-id');
        
        // --- Core App Logic ---

        /**
         * Shows a specific view and hides all others.
         * @param {string} viewId The ID of the view to show (e.g., 'home-view').
         */
        function showView(viewId) {
            allViews.forEach(view => {
                if (view.id === viewId) {
                    view.classList.remove('hidden');
                    view.classList.add('animate-fadeIn'); // Add animation
                } else {
                    view.classList.add('hidden');
                    view.classList.remove('animate-fadeIn');
                }
            });
            
            // Handle Firestore listener
            if (viewId === 'admin-view') {
                listenForHelpRequests();
            } else {
                stopListeningForRequests();
            }
            
            // Scroll to top on view change
            window.scrollTo(0, 0);
        }
        
        // Add click listeners to all navigation buttons
        navButtons.forEach(button => {
            button.addEventListener('click', () => {
                showView(button.dataset.target);
            });
        });

        /**
         * Shows a message in a specified message box.
         * @param {string} boxId - The ID of the message box element ('message-box' or 'donation-message-box').
         * @param {string} message - The text to display.
         * @param {boolean} [isError=false] - True for error (red), false for success (green).
         */
        function showMessage(boxId, message, isError = false) {
            const box = document.getElementById(boxId);
            const text = document.getElementById(boxId + '-text'); // Relies on convention e.g. 'message-box-text'
            
            if (!box || !text) return;

            text.textContent = message;
            box.classList.remove('hidden');
            if (isError) {
                box.classList.remove('bg-green-100', 'text-green-800');
                box.classList.add('bg-red-100', 'text-red-800');
            } else {
                box.classList.remove('bg-red-100', 'text-red-800');
                box.classList.add('bg-green-100', 'text-green-800');
            }
        }

        // --- "Get Help" Form Submission ---
        async function handleFormSubmit(e) {
            e.preventDefault();
            if (!db) {
                showMessage("message-box", "Database not connected. Please try again.", true);
                return;
            }

            submitText.classList.add('hidden');
            submitSpinner.classList.remove('hidden');
            submitButton.disabled = true;

            try {
                const formData = {
                    fullName: document.getElementById('full-name').value,
                    phone: document.getElementById('phone-number').value,
                    address: document.getElementById('address').value,
                    adults: parseInt(document.getElementById('adults').value, 10),
                    children: parseInt(document.getElementById('children').value, 10),
                    situation: document.getElementById('situation-details').value,
                    referenceName: document.getElementById('reference-name').value || 'N/A',
                    referencePhone: document.getElementById('reference-phone').value || 'N/A',
                    submittedAt: new Date().toISOString(),
                    submittedBy: userId 
                };

                const collectionPath = `artifacts/${appId}/public/data/help_requests`;
                await addDoc(collection(db, collectionPath), formData);
                
                helpForm.reset();
                // Show success on the *home page* after navigating back
                showView('home-view');
                // This is a bit of a hack, but we'll show a temporary message at the top
                const homeView = document.getElementById('home-view');
                const successDiv = document.createElement('div');
                successDiv.className = "mb-4 p-4 rounded-md bg-green-100 text-green-800";
                successDiv.textContent = "Your request has been submitted successfully. We will contact you soon.";
                homeView.prepend(successDiv);
                setTimeout(() => successDiv.remove(), 5000);

            } catch (error) {
                console.error("Error submitting form: ", error);
                showMessage("message-box", "There was an error submitting your request. Please try again.", true);
            } finally {
                submitText.classList.remove('hidden');
                submitSpinner.classList.add('hidden');
                submitButton.disabled = false;
            }
        }
        helpForm.addEventListener('submit', handleFormSubmit);
        
        // --- "Give Help" Donation Form (Demo) ---
        donationForm.addEventListener('submit', (e) => {
            e.preventDefault();
            // This is a demo, so we just show a thank you message
            showMessage('donation-message-box', 'Thank you for your generous (demo) contribution!', false);
        });

        // --- Admin Panel Logic ---
        function stopListeningForRequests() {
            if (unsubscribeFromRequests) {
                unsubscribeFromRequests();
                unsubscribeFromRequests = null;
            }
        }
        
        function listenForHelpRequests() {
            if (!db) return;
            if (unsubscribeFromRequests) return; // Already listening

            adminLoading.classList.remove('hidden');
            adminEmpty.classList.add('hidden');
            requestsList.innerHTML = ''; // Clear old list, but keep loading/empty states
            requestsList.prepend(adminLoading);
            requestsList.append(adminEmpty);

            const collectionPath = `artifacts/${appId}/public/data/help_requests`;
            const q = query(collection(db, collectionPath));
            
            unsubscribeFromRequests = onSnapshot(q, (querySnapshot) => {
                adminLoading.classList.add('hidden');
                
                // Clear only the rendered items
                const renderedItems = requestsList.querySelectorAll('.request-card');
                renderedItems.forEach(item => item.remove());

                if (querySnapshot.empty) {
                    adminEmpty.classList.remove('hidden');
                } else {
                    adminEmpty.classList.add('hidden');
                    
                    const docs = querySnapshot.docs
                        .map(doc => ({ id: doc.id, data: doc.data() }))
                        .sort((a, b) => new Date(b.data.submittedAt) - new Date(a.data.submittedAt));

                    docs.forEach((doc) => {
                        const request = doc.data;
                        const card = document.createElement('div');
                        card.className = 'request-card bg-white p-6 rounded-lg shadow-md border border-gray-200';
                        card.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div>
                                    <h4 class="text-xl font-bold text-indigo-700">${request.fullName}</h4>
                                    <p class="text-sm text-gray-600"><strong>Phone:</strong> ${request.phone}</p>
                                </div>
                                <span class="text-xs text-gray-500 flex-shrink-0 ml-4">${new Date(request.submittedAt).toLocaleString()}</span>
                            </div>
                            <div class="mt-4 border-t pt-4 space-y-2">
                                <p class="text-sm text-gray-700"><strong>Address:</strong> ${request.address}</p>
                                <p class="text-sm text-gray-700"><strong>Household:</strong> ${request.adults} Adults, ${request.children} Children</p>
                                <p class="mt-3 text-sm text-gray-800 bg-gray-50 p-3 rounded-md border">
                                    <strong>Situation:</strong> ${request.situation}
                                </p>
                                <p class="mt-2 text-xs text-gray-500"><strong>Reference:</strong> ${request.referenceName} (${request.referencePhone})</p>
                            </div>
                        `;
                        requestsList.appendChild(card);
                    });
                }
            }, (error) => {
                console.error("Error listening to requests: ", error);
                adminLoading.classList.add('hidden');
                requestsList.innerHTML = '<p class="text-center text-red-500">Error loading requests.</p>';
            });
        }

        // --- Initialize Firebase ---
        async function initializeFirebase() {
            try {
                const firebaseConfig = JSON.parse(firebaseConfigStr);
                if (!firebaseConfig.apiKey) {
                    console.error("Firebase config is missing.");
                    return;
                }
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug'); 

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        adminUserId.textContent = userId;
                    } else {
                        userId = null;
                        adminUserId.textContent = "Not signed in";
                    }
                });

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                // Show the home view by default
                showView('home-view');

            } catch (error) {
                console.error("Firebase initialization error:", error);
                const homeView = document.getElementById('home-view');
                homeView.innerHTML = `<div class="p-4 rounded-md bg-red-100 text-red-800 text-center"><strong>Critical Error:</strong> Could not initialize application. Firebase config might be missing or invalid.</div>`;
            }
        }
        
        // Start the application
        initializeFirebase();
    </script>
</body>
</html>
